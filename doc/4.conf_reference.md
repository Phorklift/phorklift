This document is generated by `phorklift -r`.

# Format

Command format in this document:

    `name` _(type [default=] [min=] [max=])_

`name`: Lua table supports array members and key-value map entries.
For key-value map entries, the `name` is the key.
And for array members, the `name` is `SINGLE_ARRAY_MEMBER` if only
single member is accepted, or `MULTIPLE_ARRAY_MEMBER` if multiple
members are accepted.

Supported value types includes:

  - table
  - integer
  - float
  - enumstr
  - string
  - boolean
  - function

The `default` is showed only for non-zero value.

The `min` and `max` limits are showed only if any.

# Common component tables

+ LOG _(table)_

    - `SINGLE_ARRAY_MEMBER` _(string)_

    - `level` _(enumstr, default="error", candidates: ["debug","info","warn","error","fatal"])_

    - `buffer_size` _(integer, default=16384, min=0)_

    - `max_line` _(integer, default=4096, min=80)_

+ UPSTREAM _(table)_

    Used by content modules such as proxy and redis.

    - `MULTIPLE_ARRAY_MEMBER` _(string)_

        Hostnames list. Delimiter '#' defines weight, e.g. `127.0.0.1:8080#0.2`.

    - `dynamic` _(table.DYNAMIC)_

        Do not use the static-defined hostnames; while dynamicly according to request. See `dynamic` for details.

    - `idle_max` _(integer, default=100, min=0)_

        Max idle connections.

    - `max_retries` _(integer, default=1, min=0)_

        Max retry count if connecting failure or some status-codes.

    - `retry_status_codes` _(table)_

        Retry if getting these status-codes.

        * `MULTIPLE_ARRAY_MEMBER` _(integer)_

    - `recv_timeout` _(integer, default=10, min=1)_

    - `send_timeout` _(integer, default=10, min=1)_

    - `idle_timeout` _(integer, default=60, min=1)_

    - `default_port` _(integer, min=0)_

    - `resolve_interval` _(integer, default=60, min=0)_

        Interval of resolving hostnames. Set 0 to disable.

    - `resolved_addresses_max` _(integer, default=100, min=0)_

    - `ssl` _(table)_

        Set to enable HTTPS, even to a empty table `{}`.

        * `verify` _(boolean, default=true)_

    - `failure` _(table)_

        Passive healthcheck

        * `fails` _(integer, default=1, min=0)_

            Mark an address as failure if it fails this times continuously.

        * `passes` _(integer, default=3, min=1)_

            Recover an address if it responses well this times continuously.

        * `timeout` _(integer, default=60, min=1)_

            Try to use a failure address after this time.

        * `filter` _(function)_

            Do not try a failure address on current request if this function returns false.

    - `healthcheck` _(table)_

        Active healthcheck

        * `interval` _(integer, min=0)_

            Set 0 to disable healthcheck.

        * `fails` _(integer, default=1, min=1)_

            Mark an address as failure if it fails this times continuously.

        * `passes` _(integer, default=3, min=1)_

            Recover an address if it responses well this times continuously.

        * `request` _(string)_

            Request string. If not set, connected is considered as success.

        * `response` _(string)_

            Response string used for comparison check. String `*` means accepting any response; leading `=` means exactly comparison; leading `~` means regex comparison in Lua's rule; otherwise, means prefix comparison.

    - `log` _(table.LOG)_

    - `hash` _(table)_

        Hash upstream loadbalance. Consistent hash is used. Weight is supported.

        * `SINGLE_ARRAY_MEMBER` _(function)_

            Return string as hash key.

        * `address_vnodes` _(integer, default=100, min=1)_

+ DYNAMIC _(table)_

    Included by Path and UPSTREAM to enable dynamic configuration.

    - `get_name` _(function)_

        Set this and the following `get_conf` to enable dynamic. This function should return a string as name of a sub-dynamic. This function is called for each request, so it should be fast. You can not call blocking APIs (such as `subrequest`) in this function.

    - `get_conf` _(function)_

        This function accepts a argument as sub-dynamic's name, and should return its configration, both string or Lua table type is OK. This function is called only if the sub is not existed or expired, so it need not be fast and can call blocking APIs.

    - `sub_max` _(integer, default=1000, min=0)_

    - `log` _(table.LOG)_

    - `no_stale` _(boolean)_

        For debug only.

    - `safe_mode` _(boolean)_

    - `check_interval` _(integer, min=0)_

    - `check_filter` _(function)_

    - `idle_timeout` _(integer, default=3600, min=1)_

    - `error_timeout` _(integer, default=1, min=0)_


# Runtime scope

Global runtime configuration.

+ `pid` _(string, default="phorklift.pid")_

+ `worker` _(table)_

    - `SINGLE_ARRAY_MEMBER` _(integer)_

        Worker process number. Set 0 for #CPU. Set -1 to disable master-worker mode.

    - `user` _(string)_

+ `resolver` _(table)_

    - `ai_family` _(enumstr, default="both46", candidates: ["both46","ipv4","ipv6"])_

+ `seed_random` _(boolean, default=true)_

    Disable this if you want to repeat random sequence for debug.

+ `dynamic_modules` _(table)_

    Dynamic request module list.

    - `MULTIPLE_ARRAY_MEMBER` _(string)_

+ `dynamic_upstream_modules` _(table)_

    Dynamic upstream loadbalance module list.

    - `MULTIPLE_ARRAY_MEMBER` _(string)_

+ `error_log` _(table.LOG)_


# Listen scope

This is the top level scope. Accepts one or more addresses to listen on.

+ `MULTIPLE_ARRAY_MEMBER` _(table.Host)_

    Host scope.

+ `name` _(string)_

    Listen name, only for log. The first address is used if not set.

+ `http1` _(table)_

    - `keepalive_timeout` _(integer, default=60, min=1)_

    - `keepalive_min_timeout` _(integer, default=30, min=1)_

    - `log` _(table.LOG)_

+ `http2` _(table)_

    - `idle_timeout` _(integer, default=300, min=1)_

    - `idle_min_timeout` _(integer, default=120, min=1)_

    - `ping_interval` _(integer, default=60, min=1)_

    - `header_table_size` _(integer, default=4096, min=1)_

    - `max_concurrent_streams` _(integer, default=100, min=1)_

    - `initial_window_size` _(integer, default=65535, min=1)_

    - `max_frame_size` _(integer, default=16384, min=1)_

    - `max_header_list_size` _(integer, default=100, min=1)_

    - `log` _(table.LOG)_

+ `network` _(table)_

    - `connections` _(integer, min=0)_

    - `recv_timeout` _(integer, default=10, min=1)_

    - `send_timeout` _(integer, default=10, min=1)_

    - `recv_buffer_size` _(integer, default=16384, min=4096)_

    - `send_buffer_size` _(integer, default=16384, min=4096)_

    - `backlog` _(integer, default=1000, min=1)_

    - `reuse_port` _(boolean)_

    - `defer_accept` _(integer, default=10, min=0)_


# Host scope

Under Listen scope. Accepts one or more hostnames as virtual server.

The hostname arguments may start or end with a wildcard `*`.
Especial the "*" is the default Host under the Listen scope to match any request.
Each request is matched in the order of longest match.

+ `MULTIPLE_ARRAY_MEMBER` _(table.Path)_

    Path scope.

+ `name` _(string)_

+ `ssl` _(table)_

    - `certificate` _(string)_

        Set this and the following `private_key` to enable HTTPS.

    - `private_key` _(string)_

    - `ciphers` _(string, default="ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384")_

    - `ticket_secret` _(string)_

    - `session_timeout` _(integer, default=86400, min=0)_


# Path scope

Under Host scope. Accepts one or more pathnames to route requests by URL.

The pathname arguments may start with

  - `/` means prefix-match;
  - `=` means exact-match;
  - `~` means regular expression match in Lua's rule.

Each request is matched in the order of the Paths appearance in Host scope.

+ `name` _(string)_

+ `dynamic` _(table.DYNAMIC)_

+ `module_filters` _(table)_

+ `req_body_sync` _(boolean, default=true)_

    If set, process the request only after receiving request body complete. For example if you want to accept a big-file uploading to the server, set this to false to write the request body to file in stream mode.

+ `remove_matched_prefix` _(boolean)_

    Only if pathname starts and ends with `/`.

+ `response_internal_error` _(boolean)_

    For debug.

+ `req_body_max` _(integer, default=16384, min=0)_

    Max memory buffer for request body.

+ `error_log` _(table.LOG)_

+ `access_log` _(table)_

    - `SINGLE_ARRAY_MEMBER` _(string)_

    - `sampling_rate` _(float, default=1, min=0, max=1)_

        Set 0 to disable log.

    - `format` _(function)_

        Log more fields.

    - `replace_format` _(boolean)_

        If set, log `format` only; otherwise append `format` after default fields.

    - `filter` _(function)_

        Log requests only if this function returns true.

    - `enable_subrequest` _(boolean)_

        Whether log subrequest or not.

    - `buffer_size` _(integer, default=16384, min=4096)_

    - `max_line` _(integer, default=2048)_

+ `acl` _(table)_

    Access control list (ACL) filter module.

    - `MULTIPLE_ARRAY_MEMBER` _(string)_

        Rule list. Deny-rules begin with '!', e.g "!123.234.0.0/24". The default policy is the negative of the last rule.

+ `auth_basic` _(table)_

    Basic access authentication filter module.

    - `MULTIPLE_ARRAY_MEMBER` _(string)_

        Entries in user:password format.

    - `realm` _(string, default="hello")_

    - `page` _(string)_

+ `auth_request` _(table)_

    Subrequest authentication filter module.

    - `SINGLE_ARRAY_MEMBER` _(string)_

        Path name

+ `echo` _(table)_

    Echo content module. Response a static string.

    - `SINGLE_ARRAY_MEMBER` _(string)_

        Response body.

    - `status_code` _(integer, default=200, min=200, max=599)_

+ `file_cache` _(table)_

    File cache filter module. There is no total size limit of occupation. We just clear items that inactive for a long time.

    - `SINGLE_ARRAY_MEMBER` _(string)_

        Directory to store the cache content.

    - `key` _(function)_

        Return a string as cache key. The raw URL is used if not set.

    - `expire_time` _(function)_

    - `default_expire` _(integer, min=0)_

    - `inactive` _(integer, default=10800, min=0)_

        Cache items will be deleted if inactive such long time.

    - `dir_level` _(integer, default=1, min=0, max=3)_

        This should be set as `floor(log[256]N) - 1` where N is the estimated number of cache items.

    - `max_length` _(integer, min=0)_

    - `status_codes` _(table)_

        * `MULTIPLE_ARRAY_MEMBER` _(integer)_

    - `include_headers` _(table)_

        * `MULTIPLE_ARRAY_MEMBER` _(string)_

    - `exclude_headers` _(table)_

        * `MULTIPLE_ARRAY_MEMBER` _(string)_

    - `log` _(table.LOG)_

+ `gzip` _(table)_

    Gzip filter module.

    - `SINGLE_ARRAY_MEMBER` _(integer, min=0, max=9)_

        Compress level. 0 is disable, 1 is fastest, and 9 is best compression.

    - `window_bits` _(integer, default=15, min=8, max=15)_

    - `mem_level` _(integer, default=8, min=1, max=9)_

    - `min_length` _(integer, default=100, min=0)_

    - `filter` _(function)_

        Return a boolean to indicate whether to compress.

+ `jump_if` _(table)_

    Save the response to some Path by subrequest.

+ `limit_req` _(table)_

    Request rate limit filter module.

    - `SINGLE_ARRAY_MEMBER` _(float, min=0)_

        Limit rate per second.

    - `burst` _(float, min=0)_

        Burst rate per second.

    - `key` _(function)_

        Return a string key and optional weight. Client IP address is used if not set.

    - `key_max_len` _(function)_

    - `size` _(integer, default=65536, min=16384)_

        Size of shared-memory.

    - `add_headers` _(boolean, default=true)_

        Add `X-RateLimit-*` response headers.

    - `status_code` _(integer, default=503, min=200, max=599)_

    - `page` _(string)_

    - `log` _(table.LOG)_

+ `proxy` _(table)_

    Proxy content module.

    - `SINGLE_ARRAY_MEMBER` _(table.UPSTREAM)_

    - `x_forwarded_for` _(boolean)_

        Whether to update X-Forwarded-For header.

    - `replace_host` _(boolean)_

        Whether to replace Host header by upstream server hostname.

+ `random_cookie_id` _(table)_

    Set cookie ID in response header

    - `check_mode` _(boolean)_

        If set, check the request Cookie header. Otherwise add Set-cookie header if need.

    - `secret` _(string)_

    - `name` _(string, default="ID")_

    - `domain` _(string)_

    - `path` _(string)_

    - `max_age` _(integer)_

    - `secure` _(boolean)_

    - `HttpOnly` _(boolean)_

+ `redis` _(table)_

    Redis module.

    - `SINGLE_ARRAY_MEMBER` _(table.UPSTREAM)_

    - `query` _(function)_

+ `response_headers` _(table)_

    Set cookie ID in response header

    - `check_server_via` _(boolean, default=true)_

    - `check_date` _(boolean, default=true)_

+ `rewrite` _(table)_

    URL rewrite filter module.

    - `MULTIPLE_ARRAY_MEMBER` _(string)_

        Rewrite rules list.

+ `save_to` _(table)_

    Save the response to some Path by subrequest.

    - `SINGLE_ARRAY_MEMBER` _(string)_

        The pathname to save to.

    - `default_expire` _(integer, min=0)_

    - `max_length` _(integer, min=0)_

    - `status_codes` _(table)_

        * `MULTIPLE_ARRAY_MEMBER` _(integer)_

    - `log` _(table.LOG)_

+ `script` _(table)_

    - `SINGLE_ARRAY_MEMBER` _(function)_

        Content handler.

    - `request_headers` _(function)_

        Process request headers filter.

    - `request_body` _(function)_

        Process request body filter.

    - `response_headers` _(function)_

        Process response headers filter.

    - `response_body` _(function)_

        Process response body filter.

+ `static` _(table)_

    Static file content module.

    - `SINGLE_ARRAY_MEMBER` _(string)_

        The directory.

    - `index` _(string, default="index.html")_

        Set the index file if directory is queried. Only works if list_dir=off.

    - `list_dir` _(enumstr, default="off", candidates: ["off","plain"])_

    - `enable_upload` _(boolean)_

    - `log` _(table.LOG)_

+ `stats` _(boolean)_

    Statistics content module.

